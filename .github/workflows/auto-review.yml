name: Gemini AI Code Review
on:
  pull_request:
    types: [opened]

jobs:
  review:
    if: github.event.issue.pull_request && contains(github.event.comment.body, '/review')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write # Required to post comments
      issues: read

    steps:
      - name: Generate GitHub App Token
        id: app-token
        if: ${{ vars.APP_ID }}
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
      - uses: actions/checkout@v4
      - name: Acknowledge Request
        run: echo "ðŸ” Review requested by ${{ github.event.comment.user.login }}..."
      - name: Checkout PR Branch
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: gh pr checkout ${{ github.event.issue.number }}
      # 1. Install Node.js
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 2. Install Gemini CLI
      - name: Install Gemini CLI
        run: npm install -g @google/gemini-cli

      # 3. Authenticate to Google Cloud (The Safe Way)
      - id: 'auth'
        name: 'Authenticate to GCP'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      # 4. Run the Review
      - name: Gemini Code Review
        env:
          # auth step automatically sets GOOGLE_APPLICATION_CREDENTIALS
          GOOGLE_CLOUD_PROJECT: "complytime-test"
          GOOGLE_CLOUD_LOCATION: "us-central1"
          GOOGLE_GENAI_USE_VERTEXAI: "true"
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          echo "ðŸ¤– Reviewing PR #${{ github.event.issue.number }}..."
          
          # Get the diff
          gh pr diff ${{ github.event.issue.number }} > pr_diff.txt

          # Check size to save money/tokens
          if [ $(wc -c < pr_diff.txt) -gt 40000 ]; then
             echo "âš ï¸ **Skipping Review:** Diff is too large (>40k chars)." > review.md
          else
             echo "## ðŸ¤– Gemini Code Review" > review.md
             echo "run by @${{ github.event.comment.user.login }}" >> review.md
             echo "" >> review.md
             
             # The Prompt
             cat pr_diff.txt | head -c 12000 | gemini "Act as a senior engineer. Review this diff. Flag bugs, security risks, and messy code. Be concise. Use Markdown." >> review.md
          fi

          # Post the comment
          gh pr comment ${{ github.event.issue.number }} -F review.md
          
          # Optional: React to the user's comment to show it worked
          gh api reactions -f content='+1' /repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions
