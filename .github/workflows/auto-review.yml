name: Gemini AI Code Review
on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write # Required to post comments

    steps:
      - uses: actions/checkout@v4

      # 1. Install Node.js
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 2. Install Gemini CLI
      - name: Install Gemini CLI
        run: npm install -g @google/gemini-cli

      # 3. Authenticate to Google Cloud (The Safe Way)
      - id: 'auth'
        name: 'Authenticate to GCP'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Generate GitHub App Token
        id: app-token
        if: ${{ vars.APP_ID }}
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}

      # 4. Run the Review
      - name: Gemini Code Review
        env:
          # auth step automatically sets GOOGLE_APPLICATION_CREDENTIALS
          GOOGLE_CLOUD_PROJECT: "complytime-test"
          GOOGLE_CLOUD_LOCATION: "us-central1"
          GOOGLE_GENAI_USE_VERTEXAI: "true"
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          # Get the diff (limit to 12000 chars to avoid token limits)
          gh pr diff ${{ github.event.pull_request.number }} > pr_diff.txt
          
          # Check if diff is too big, otherwise review it
          if [ $(wc -c < pr_diff.txt) -gt 40000 ]; then
             echo "Diff is too large for a full review." > review.md
          else
             echo "## ðŸ¤– Gemini Code Review" > review.md
             cat pr_diff.txt | gemini "Act as a senior software engineer. Review this pull request diff. Identify critical issues, suggest improvements, and summarize changes." >> review.md
          fi
          
          # Post the comment
          gh pr comment ${{ github.event.pull_request.number }} -F review.md
